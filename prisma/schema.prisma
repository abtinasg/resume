datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id              String             @id @default(cuid())
  email           String             @unique
  password        String?
  name            String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  profile         UserProfile?
  resumes         ResumeVersion[]
  applications    Application[]
  events          InteractionEvent[]
  strategyHistory StrategyHistory[]

  @@index([email])
}

model UserProfile {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  experienceYears     Int?
  currentRole         String?
  targetRoles         Json     @default("[]")
  techStack           Json     @default("[]")
  currentLocation     String?
  targetLocations     Json     @default("[]")
  workAuthorization   String?
  remoteOnly          Boolean  @default(false)
  companySizePrefs    Json     @default("[]")
  industries          Json     @default("[]")
  salaryExpectation   Json?
  currentStrategyMode String   @default("IMPROVE_RESUME_FIRST")
  weeklyAppTarget     Int      @default(5)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model ResumeVersion {
  id               String        @id @default(cuid())
  userId           String
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  versionNumber    Int
  name             String?
  isMaster         Boolean       @default(false)

  content          Json
  overallScore     Int?
  sectionScores    Json?
  improvementAreas Json          @default("[]")
  targetRoles      Json          @default("[]")

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  applications     Application[]

  @@index([userId, isMaster])
  @@index([userId, versionNumber])
}

model JobPosting {
  id                  String        @id @default(cuid())
  title               String
  company             String
  location            String?
  jobUrl              String
  description         String?
  seniorityLevel      String?
  requiredSkills      Json          @default("[]")
  remoteOption        Boolean       @default(false)
  salaryRange         Json?
  discoveredAt        DateTime      @default(now())
  source              String        @default("user_provided")
  discoveredViaQuery  String?
  matchScore          Int?
  matchReasoning      Json?

  applications        Application[]

  @@index([source, discoveredAt])
}

model Application {
  id                 String        @id @default(cuid())
  userId             String
  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  resumeId           String
  resume             ResumeVersion @relation(fields: [resumeId], references: [id])

  jobId              String
  job                JobPosting    @relation(fields: [jobId], references: [id])

  status             String        @default("draft")
  appliedAt          DateTime?
  lastFollowUpAt     DateTime?
  followUpCount      Int           @default(0)

  customCoverLetter  String?
  customMessage      String?

  interviewScheduledAt DateTime?
  offerReceivedAt      DateTime?
  rejectedAt           DateTime?

  notes              String?
  metadata           Json?

  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@index([userId, status])
  @@index([userId, createdAt])
}

enum EventType {
  APPLICATION_CREATED
  APPLICATION_SUBMITTED
  APPLICATION_UPDATED
  INTERVIEW_SCHEDULED
  INTERVIEW_COMPLETED
  OFFER_RECEIVED
  SUGGESTION_GENERATED
  SUGGESTION_ACCEPTED
  SUGGESTION_REJECTED
  STRATEGY_MODE_CHANGED
  JOB_DISCOVERED
  JOB_SCORED
  RESUME_UPLOADED
  RESUME_SCORED
}

model InteractionEvent {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventType EventType
  context   Json
  metadata  Json?
  timestamp DateTime  @default(now())

  @@index([userId, timestamp])
  @@index([eventType, timestamp])
}

model StrategyHistory {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  strategyMode  String
  reason        String
  triggeredBy   String

  activatedAt   DateTime @default(now())
  deactivatedAt DateTime?

  performanceData Json?

  @@index([userId, activatedAt])
}
