// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id              String             @id @default(cuid())
  email           String             @unique
  name            String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  profile         UserProfile?
  resumes         ResumeVersion[]
  applications    Application[]
  events          InteractionEvent[]
  strategyHistory StrategyHistory[]

  @@index([email])
}

model UserProfile {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  experienceYears     Int?
  currentRole         String?
  targetRoles         String   // JSON array stored as string for SQLite
  techStack           String   // JSON array stored as string for SQLite
  currentLocation     String?
  targetLocations     String   // JSON array stored as string for SQLite
  workAuthorization   String?
  remoteOnly          Boolean  @default(false)
  companySizePrefs    String   // JSON array stored as string for SQLite
  industries          String   // JSON array stored as string for SQLite
  salaryExpectation   String?  // JSON object stored as string for SQLite
  currentStrategyMode String   @default("IMPROVE_RESUME_FIRST")
  weeklyAppTarget     Int      @default(5)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model ResumeVersion {
  id               String        @id @default(cuid())
  userId           String
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  versionNumber    Int
  name             String?
  isMaster         Boolean       @default(false)
  content          String        // JSON object stored as string for SQLite
  overallScore     Int?
  sectionScores    String?       // JSON object stored as string for SQLite
  improvementAreas String        // JSON array stored as string for SQLite
  targetRoles      String        // JSON array stored as string for SQLite
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  applications     Application[]

  @@index([userId, isMaster])
}

model JobPosting {
  id                  String        @id @default(cuid())
  title               String
  company             String
  location            String?
  jobUrl              String
  description         String?
  seniorityLevel      String?
  requiredSkills      String        // JSON array stored as string for SQLite
  remoteOption        Boolean       @default(false)
  salaryRange         String?       // JSON object stored as string for SQLite
  discoveredAt        DateTime      @default(now())
  source              String        @default("user_provided")
  discoveredViaQuery  String?
  matchScore          Int?
  matchReasoning      String?       // JSON object stored as string for SQLite
  status              String        @default("discovered")
  updatedAt           DateTime      @updatedAt
  applications        Application[]
}

model Application {
  id                  String        @id @default(cuid())
  userId              String
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobId               String
  job                 JobPosting    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  resumeVersionId     String
  resumeVersion       ResumeVersion @relation(fields: [resumeVersionId], references: [id])

  appliedAt           DateTime?
  status              String        @default("draft")
  coverLetterUsed     String?
  outreachSent        Boolean       @default(false)
  outreachMessage     String?
  lastFollowUp        DateTime?
  followUpCount       Int           @default(0)
  outcome             String?
  outcomeDate         DateTime?
  outcomeNotes        String?
  strategyModeAtApply String?

  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@index([userId, status])
  @@index([userId, appliedAt])
  @@index([userId, lastFollowUp])
}

model InteractionEvent {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventType String
  timestamp DateTime @default(now())
  context   String   // JSON object stored as string for SQLite
  sessionId String?
  metadata  String?  // JSON object stored as string for SQLite

  @@index([userId, timestamp])
  @@index([userId, eventType, timestamp])
}

model StrategyHistory {
  id                 String    @id @default(cuid())
  userId             String
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategyMode       String
  activatedAt        DateTime  @default(now())
  deactivatedAt      DateTime?
  reason             String
  metricsAtStart     String    // JSON object stored as string for SQLite
  metricsAtEnd       String?   // JSON object stored as string for SQLite
  applicationsInMode Int       @default(0)
  interviewsInMode   Int       @default(0)

  @@index([userId, deactivatedAt])
}
